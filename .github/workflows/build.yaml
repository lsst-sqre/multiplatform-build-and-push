name: Multiplatform build-and-push

on:
  workflow_call:
    inputs:
      images:
        description: "Fully-qualified URIs for output Docker images, comma-separated string."
        required: true
        type: string
      tag:
        description: "Tag for image (optional). If not set, tag will be derived from the git branch."
        required: false
        type: string
      dockerfile:
        description: "The name of the Dockerfile to build."
        required: false
        default: "Dockerfile"
        type: string
      context:
        description: "The build context to use."
        required: false
        default: "."
        type: string
      cache:
        description: "Whether to use GitHub cache for images.  If they are very large, you might not want to."
        required: false
        default: true
        type: boolean
      push:
        description: "Whether to push the images."
        required: false
        default: true
        type: boolean
      additional-tags:
        description: "Additional tags to add to built image, comma-separated string."
        required: false
        default: ""
        type: string
      build-args:
        description: "List of build-time variables."
        required: false
        type: string
      target:
        description: "Name of target stage to build."
        required: false
        type: string
      use-nonstandard-ghcr-token:
        description: "Accomodation for sciplat-lab: if set, use GHCR_PUSH_TOKEN rather than GITHUB_TOKEN"
        required: false
        type: boolean
        default: false
    secrets:
      DOCKER_USERNAME:
        required: false
      DOCKER_TOKEN:
        required: false
      GHCR_PUSH_TOKEN:
        required: false
      GAR_PUSH_TOKEN:
        required: false


# We need actions/write if we want to do a GH App, and we need
# packages/write to push to ghcr.io with GITHUB_TOKEN
permissions:
  actions: write
  contents: read
  packages: write
  statuses: read

jobs:
  setup:
    runs-on: ubuntu-latest
    env:
      images: ${{ inputs.images }}
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v5
        with:
          path: 'action-shell'
          repository: lsst-sqre/multiplatform-build-and-push

      - name: Define the tag
        id: tag
        shell: bash
        env:
          tag: ${{ inputs.tag }}
        run: |
          # Use existing tag if we have one; otherwise, get one from git.
          if [ -z "${tag}" ]; then
              . ${GITHUB_WORKSPACE}/action-shell/functions.sh
              tag=$( docker_tag )
          fi
          echo "tag=${tag}" >> ${GITHUB_OUTPUT}

  containers:
    needs: setup
    runs-on: ${{ matrix.platform.runs_on }}
    timeout-minutes: 60
    env:
      tag: ${{ needs.setup.outputs.tag }}
      images: ${{ inputs.images }}
      platform: ${{ matrix.platform.arch }}
      additional_tags: ${{ inputs.additional-tags }}

    strategy:
      matrix:
        platform:
          - arch: "amd64"
            runs_on: "ubuntu-latest"
          - arch: "arm64"
            runs_on: "ubuntu-24.04-arm"
    steps:
      - name: Checkout source
        uses: actions/checkout@v5

      - name: Checkout scripts
        uses: actions/checkout@v5
        with:
          path: 'action-shell'
          repository: lsst-sqre/multiplatform-build-and-push

      - name: Login
        uses: lsst-sqre/multi-repository-login@v1
        with:
          images: ${{ env.images }}
          use_nonstandard_ghcr_token: ${{ inputs.use-nonstandard-ghcr-token }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
          GAR_PUSH_TOKEN: ${{ secrets.GAR_PUSH_TOKEN }}
          GHCR_PUSH_TOKEN: ${{ secrets.GHCR_PUSH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate tags
        id: calculate_tags
        shell: bash
        run: |
          . ${GITHUB_WORKSPACE}/action-shell/functions.sh
          tags=$( calculate_tags )
          echo "tags=${tags}" >> ${GITHUB_OUTPUT}

      - name: Setup buildx
        uses: docker/setup-buildx-action@v3
        with:
          name: builder-${{ matrix.platform.arch }}
          platforms: linux/${{ matrix.platform.arch }}

      - name: Calculate cache parameters
        id: calculate_cache_params
        shell: bash
        env:
          cache: ${{ inputs.cache }}
        run:
          cache_from="";
          cache_to="";
          if [ "${cache}" != "false" ]; then
              cache_from="type=gha";
              cache_to="type=gha,mode=max";
          fi;
          echo "cache_from=${cache_from}" >> ${GITHUB_OUTPUT} ;
          echo "cache_to=${cache_to}" >> ${GITHUB_OUTPUT}

      - name: Build container
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          push: ${{ inputs.push }}
          target: ${{ inputs.target }}
          build-args: ${{ inputs.build-args }}
          builder: builder-${{ matrix.platform.arch }}
          platforms: linux/${{ matrix.platform.arch }}
          tags: ${{ steps.calculate_tags.outputs.tags }}
          cache-from: ${{ steps.calculate_cache_params.outputs.cache_from }}
          cache-to: ${{ steps.calculate_cache_params.outputs.cache_to }}

  manifest:
    needs: [setup, containers]
    runs-on: ubuntu-latest
    env:
      tag: ${{ needs.setup.outputs.tag }}
      images: ${{ inputs.images }}
      additional_tags: ${{ inputs.additional-tags }}
    if: ${{ inputs.push }}

    timeout-minutes: 30
    steps:
      - name: Checkout scripts
        uses: actions/checkout@v5
        with:
          path: 'action-shell'
          repository: lsst-sqre/multiplatform-build-and-push

      - name: Login
        uses: lsst-sqre/multi-repository-login@v1
        with:
          images: ${{ env.images }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
          GAR_PUSH_TOKEN: ${{ secrets.GAR_PUSH_TOKEN }}
          GHCR_PUSH_TOKEN: ${{ secrets.GHCR_PUSH_TOKEN }}

      - name: Calculate tags
        id: make_total_tagset
        shell: bash
        run: |
          . ${GITHUB_WORKSPACE}/action-shell/functions.sh
          t1=$( platform=amd64 calculate_tags )
          t2=$( platform=arm64 calculate_tags )
          in_tags="${t1},${t2}"
          out_tags=$(echo ${t1} | sed -e 's/-amd64,/,/g' -e 's/-amd64$//g' )
          echo "in_tags=${in_tags}" >> ${GITHUB_OUTPUT}
          echo "out_tags=${out_tags}" >> ${GITHUB_OUTPUT}

      - name: Build multi-platform manifest
        uses: Noelware/docker-manifest-action@v1
        with:
          inputs: ${{ steps.make_total_tagset.outputs.in_tags }}
          tags: ${{ steps.make_total_tagset.outputs.out_tags }}
          push: ${{ inputs.push }}
